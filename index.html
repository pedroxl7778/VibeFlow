<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Clone: Avan√ßado</title>
    
    <style>
        /* Vari√°veis de Tema (Default: Dark) */
        :root {
            /* Cores de Fundo (Modo Escuro Padr√£o) */
            --bg-dark: #121212;
            --bg-medium: #181818;
            --bg-light: #282828;

            /* Cores de Fundo (Modo Claro - Apenas se tema-mode for 'light') */
            --bg-light-main: #f0f0f0;
            --bg-light-medium: #ffffff;
            --bg-light-dark: #e0e0e0;
            
            /* Cores de Texto */
            --color-text: #ffffff;
            --color-subtext: #b3b3b3;
            --color-text-dark: #000000;

            /* Cores de Acento */
            --color-primary: #1DB954; /* Verde do Spotify */
            --color-red: #ff4d4d;
            --color-yellow: #FFC300; 

            /* Cor de Fundo Principal Aplicada */
            --main-background: var(--bg-dark);
            --secondary-background: var(--bg-medium);
            --tertiary-background: var(--bg-light);
            --current-text-color: var(--color-text);
            --current-subtext-color: var(--color-subtext);
        }

        /* Aplica√ß√£o do Tema Claro */
        body.light-mode {
            --main-background: var(--bg-light-main);
            --secondary-background: var(--bg-light-dark);
            --tertiary-background: var(--bg-light-medium);
            --current-text-color: var(--color-text-dark);
            --current-subtext-color: #555555;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            background-color: var(--main-background); 
            color: var(--current-text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* LAYOUT PRINCIPAL (TopBar + Main + Sidebar) */
        .top-bar {
            height: 60px; background-color: var(--secondary-background); display: flex;
            justify-content: space-between; align-items: center; padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); z-index: 10;
        }
        .top-bar-left {
            display: flex; align-items: center; gap: 15px;
        }
        .premium-btn {
            background-color: var(--color-yellow); color: #121212; font-weight: bold;
            padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer;
            text-transform: uppercase; font-size: 0.8em; transition: transform 0.1s;
        }
        .premium-btn:hover { transform: scale(1.05); }
        .premium-btn.active { background-color: var(--color-primary); color: white; cursor: default; }
        
        /* Bot√£o de Configura√ß√µes */
        #settings-btn {
            background: none; border: none; color: var(--current-subtext-color); 
            font-size: 1.5em; cursor: pointer; margin-right: 15px; transition: color 0.2s;
        }
        #settings-btn:hover { color: var(--color-primary); }


        .user-profile { 
            display: flex; align-items: center; background-color: rgba(0, 0, 0, 0.4); 
            border-radius: 23px; padding: 3px 8px 3px 3px; cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .user-profile:hover { background-color: rgba(0, 0, 0, 0.6); }
        body.light-mode .user-profile { background-color: rgba(255, 255, 255, 0.4); }

        #profile-image { 
            width: 35px; height: 35px; border-radius: 50%; 
            background-color: #333; margin-right: 8px; object-fit: cover; 
        }
        #profile-name { font-weight: bold; font-size: 0.9em; margin-right: 10px; }


        /* Conte√∫do Principal */
        .main-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background-color: var(--secondary-background); padding: 20px 0; overflow-y: auto; }
        .nav-item { padding: 10px 20px; cursor: pointer; font-weight: bold; color: var(--current-subtext-color); transition: color 0.2s; }
        .nav-item:hover, .nav-item.active { color: var(--current-text-color); }
        
        /* Nav Item de Curtidas (sem √≠cone de lixeira/delete) */
        .liked-songs-nav { 
            background-color: var(--tertiary-background); /* Fundo diferente para destaque */
        }
        
        .library-header { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; margin-top: 20px; }
        .library-header h3 { color: var(--current-subtext-color); font-size: 0.9em; margin: 0; }
        .create-btn { background-color: transparent; border: none; color: var(--current-subtext-color); font-size: 1.5em; cursor: pointer; transition: color 0.2s; }
        .create-btn:hover { color: var(--current-text-color); }
        .playlist-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 20px; cursor: pointer; transition: background-color 0.2s; font-size: 0.9em; }
        .playlist-item:hover { background-color: var(--tertiary-background); }
        .playlist-name-link { flex-grow: 1; }
        .delete-btn { background-color: transparent; border: none; color: var(--color-red); font-size: 0.9em; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .playlist-item:hover .delete-btn { opacity: 1; }
        .main-content { flex: 1; background-color: var(--main-background); padding: 20px; overflow-y: auto; }
        .section-content { display: none; }
        .section-content.active { display: block; }

        /* Estilos de Lista de Faixas */
        .track-list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; margin-bottom: 5px; border-radius: 5px; 
            transition: background-color 0.2s; 
        }
        .track-list-item:hover { background-color: var(--tertiary-background); }
        .track-list-item.playing { 
            background-color: var(--tertiary-background); 
            border-left: 3px solid var(--color-primary); 
        }
        .track-list-item.playing .track-title { color: var(--color-primary); }
        .track-info { flex-grow: 1; cursor: pointer; }
        .track-title { font-weight: bold; }
        .track-artist { font-size: 0.8em; color: var(--current-subtext-color); }
        .track-index { width: 30px; text-align: center; color: var(--current-subtext-color); }
        .track-actions { display: flex; gap: 10px; }
        .action-btn {
            background-color: transparent; border: none; color: var(--current-subtext-color); 
            font-size: 1.2em; cursor: pointer; transition: color 0.2s;
        }
        .action-btn.add:hover { color: var(--color-primary); }
        .action-btn.remove:hover { color: var(--color-red); }
        .action-btn.like { font-size: 1em; }
        .action-btn.liked { color: var(--color-primary); } /* Cora√ß√£o preenchido/verde */
        

        /* Estilos de Gerenciamento de Conta */
        .account-form {
            max-width: 400px;
            margin-top: 20px;
            padding: 20px;
            background-color: var(--tertiary-background);
            border-radius: 8px;
        }
        .account-form input[type="text"], .account-form input[type="file"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #333;
            color: var(--color-text);
        }
        body.light-mode .account-form input[type="text"] {
             background-color: var(--bg-light-main);
             color: var(--color-text-dark);
             border: 1px solid #ccc;
        }
        .account-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .account-form button {
            background-color: var(--color-primary);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        #current-photo-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #333;
            margin-bottom: 15px;
            object-fit: cover;
        }
        #google-connect-btn {
            background-color: #4285F4; /* Azul do Google */
            color: white;
        }
        
        /* Player Bar e Flyout (mantidos) */
        .player-bar { 
            height: 90px; background-color: var(--tertiary-background); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; border-top: 1px solid #000; 
            position: relative; 
        }
        body.light-mode .player-bar {
            border-top: 1px solid #ccc;
        }
        #song-details-flyout {
            position: absolute; bottom: 90px; left: 0; width: 100%; height: 400px;
            background-color: var(--main-background); box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.8);
            z-index: 15; display: none; flex-direction: column; align-items: center;
            justify-content: center; padding: 20px; transition: bottom 0.3s ease-out;
        }
        #flyout-cover {
            width: 250px; height: 250px; background-color: #333; border-radius: 8px;
            margin-bottom: 20px; font-size: 5em; display: flex; align-items: center;
            justify-content: center; background-size: cover; background-position: center;
        }
        #flyout-title { font-size: 1.8em; font-weight: bold; margin-bottom: 5px; }
        #flyout-artist { font-size: 1.2em; color: var(--current-subtext-color); margin-bottom: 20px; }
        #flyout-back-btn {
            background-color: var(--secondary-background); color: var(--current-text-color); 
            padding: 10px 20px; border: 1px solid var(--current-subtext-color); 
            border-radius: 20px; cursor: pointer; font-weight: bold;
            transition: background-color 0.2s;
        }
        #flyout-back-btn:hover { background-color: #404040; }


        .song-info { display: flex; align-items: center; width: 30%; }
        .song-cover { 
            width: 60px; height: 60px; background-color: #333; border-radius: 4px; 
            margin-right: 15px; font-size: 1.5em; display: flex; align-items: center; 
            justify-content: center; background-size: cover; background-position: center;
        }
        /* Efeito visual para capa de An√∫ncio */
        .song-cover.ad-cover {
            background-color: var(--color-yellow);
            color: var(--bg-dark);
            font-weight: bold;
            font-size: 1.2em;
        }
        .song-details { cursor: pointer; } 
        .song-details #player-title { 
            font-weight: bold; color: var(--current-text-color); transition: color 0.1s;
        }
        .song-details #player-title:hover {
            color: var(--color-primary); 
        }
        /* Mensagem do An√∫ncio em destaque */
        .song-details #player-artist.ad-message { 
            color: var(--color-yellow); 
            font-weight: bold;
        }
        
        /* Controles do Player */
        .player-controls { width: 40%; display: flex; flex-direction: column; align-items: center; }
        .controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 5px; }
        .control-btn { background: none; border: none; color: var(--current-text-color); font-size: 1.5em; cursor: pointer; transition: color 0.2s; }
        .control-btn:hover:not(:disabled) { color: var(--color-primary); }
        .control-btn:disabled { color: var(--current-subtext-color); opacity: 0.5; cursor: default; } /* Cor para desativado */

        .progress-container { width: 100%; display: flex; align-items: center; gap: 10px; font-size: 0.75em; color: var(--current-subtext-color); }
        #seek-bar { flex: 1; height: 4px; }
        #seek-bar:not(:disabled) { cursor: pointer; }
        #seek-bar:disabled { cursor: default; opacity: 0.5; }

        /* Controles de Volume */
        .volume-control { width: 30%; display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        #volume-slider { width: 100px; height: 4px; cursor: pointer; }
        #volume-icon { font-size: 1.2em; color: var(--current-text-color); }


        #audio-player { display: none; }
        
        /* Modais */
        .modal { display: none; position: fixed; z-index: 20; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: var(--tertiary-background); margin: 10% auto; padding: 30px; border-radius: 10px; width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.9); color: var(--current-text-color); }
        .close-btn { color: var(--current-subtext-color); float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: var(--current-text-color); text-decoration: none; cursor: pointer; }
        .modal-content button { background-color: var(--color-primary); color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }

        /* Novo modal para o Perfil (A√ß√µes) */
        #profile-actions-modal .modal-content {
             width: 250px;
        }
        #profile-actions-modal button {
            background-color: var(--secondary-background);
            border: 1px solid var(--current-subtext-color);
            width: 100%;
        }
        #profile-actions-modal button:hover {
            background-color: var(--tertiary-background);
        }
        
        /* Modal de Configura√ß√µes */
        #settings-modal .modal-content {
            width: 350px;
        }
        .setting-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--current-subtext-color);
            border-radius: 8px;
        }
        .setting-group h4 {
            color: var(--color-primary);
            margin-top: 0;
        }
        .color-option {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s, transform 0.1s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: var(--color-primary);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        #theme-mode-switch {
            width: 100%;
            height: 40px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
        }
        .switch-dark { background-color: var(--bg-dark); color: white; border: 1px solid white !important; }
        .switch-light { background-color: var(--bg-light-main); color: var(--color-text-dark); border: 1px solid black !important;}

    </style>
</head>
<body class="dark-mode"> <div class="top-bar">
        <div class="top-bar-left">
            <button id="premium-toggle-btn" class="premium-btn" onclick="openPremiumModal()">
                Obter Premium
            </button>
        </div>

        <div style="display: flex; align-items: center;">
             <button id="settings-btn" title="Configura√ß√µes" onclick="openSettingsModal()">
                ‚öôÔ∏è
             </button>
            <div class="user-profile" onclick="openProfileActionsModal()">
                <img id="profile-image" src="" alt="Foto de Perfil">
                <span id="profile-name">Convidado</span>
                <span style="font-size: 1.2em; color: var(--current-subtext-color);">‚ñº</span>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('settings-modal').style.display='none';">&times;</span>
            <h2 style="color: var(--color-primary);">Configura√ß√µes de Tema</h2>

            <div class="setting-group">
                <h4>Modo de Cor</h4>
                <button id="theme-mode-switch" onclick="toggleThemeMode()"></button>
                <p style="font-size: 0.8em; color: var(--current-subtext-color);">Alterne entre modo escuro (Dark) e modo claro (Light).</p>
            </div>

            <div class="setting-group">
                <h4>Cor de Destaque (Acento)</h4>
                <div id="color-options-container">
                    </div>
                <p style="font-size: 0.8em; color: var(--current-subtext-color);">Escolha a cor prim√°ria que substitui o verde padr√£o.</p>
            </div>

            <button onclick="saveThemeSettings()">Salvar Configura√ß√µes</button>
        </div>
    </div>

    <div id="profile-actions-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeProfileActionsModal()">&times;</span>
        <h3 style="margin-bottom: 20px;">Ol√°, <span id="modal-user-name"></span></h3>

        <div id="logged-out-actions" style="display: none;">
             <button id="google-connect-btn" onclick="simulateGoogleLogin()">
                <img src="imagens/google_icon.png" alt="G" style="width: 16px; margin-right: 5px; vertical-align: middle;">
                Conectar com Google (Simulado)
             </button>
        </div>

        <div id="logged-in-actions" style="display: none;">
            <button onclick="manageAccount()">Gerenciar Conta</button>
            <button onclick="logout()" style="background-color: var(--color-red); margin-top: 15px;">Sair</button>
        </div>
        
      </div>
    </div>

    <div id="premium-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closePremiumModal()">&times;</span>
        <h2 style="color: var(--color-primary);">Spotify Clone Premium</h2>
        <p style="font-size: 1.2em; font-weight: bold;">R$ 19,90 / m√™s (Simula√ß√£o)</p>
        <p>Desfrute dos melhores benef√≠cios:</p>
        <ul class="modal-benefits">
            <li>M√∫sicas sem interrup√ß√µes de an√∫ncios.</li>
            <li>Qualidade de √°udio superior.</li>
            <li>Poder de pular ilimitado.</li>
            <li>Suporte ao desenvolvedor!</li>
        </ul>
        <h3 style="margin-top: 20px;">Simula√ß√£o de Pagamento</h3>
        <label for="card-number">N√∫mero do Cart√£o:</label>
        <input type="text" id="card-number" placeholder="XXXX XXXX XXXX XXXX"> 
        <button onclick="simulatePurchase()">Pagar R$ 19,90 e Ativar Premium</button>
      </div>
    </div>
    <div id="playlist-select-modal" class="modal">
        <div class="modal-content" style="width: 250px;">
            <span class="close-btn" onclick="closePlaylistSelectModal()">&times;</span>
            <h3 style="color: var(--color-primary);">Adicionar √† Playlist</h3>
            <p style="font-size: 0.9em; margin-bottom: 15px;">Selecione onde adicionar a m√∫sica:</p>
            <div id="playlist-options-container">
            </div>
            <button onclick="createNewPlaylist(true)">+ Criar Nova Playlist</button>
        </div>
    </div>


    <div class="main-wrapper">
        <div class="sidebar">
            <div class="nav-item active" data-section="home" onclick="showSection('home')">
                üè† In√≠cio
            </div>
            <div class="nav-item" data-section="explore" onclick="showSection('explore')">
                üîç Explorar
            </div>
            <div class="nav-item liked-songs-nav" data-section="liked-songs" onclick="showSection('liked-songs')">
                ‚ù§Ô∏è M√∫sicas Curtidas
            </div>
            <div class="nav-item" data-section="library" onclick="showSection('library')">
                üìö Biblioteca
            </div>

            <div class="library-header">
                <h3>Suas Playlists</h3>
                <button class="create-btn" title="Criar nova playlist" onclick="createNewPlaylist()">+</button>
            </div>
            <div id="playlists-list">
            </div>
        </div>

        <div class="main-content">
            <button id="back-button" style="display:none; background:none; border:none; color:var(--current-text-color); font-size:1.5em; margin-bottom: 20px; cursor:pointer;" onclick="goBack()">
                ‚Üê Voltar
            </button>


            <div id="home-content" class="section-content active">
                <h2>Ol√°, <span id="welcome-name">Convidado</span>!</h2>
                <p>Status: <span id="user-status-text" style="font-weight: bold;">Gratuito (com an√∫ncios)</span></p>
                <div id="home-warning"></div>
                <div id="playlist-view-home">
                </div>
            </div>

            <div id="account-management-content" class="section-content">
                <h2 style="color: var(--color-primary);">Gerenciar Conta</h2>
                <div class="account-form">
                    <label for="account-first-name">Nome:</label>
                    <input type="text" id="account-first-name" placeholder="Primeiro Nome">

                    <label for="account-last-name">Sobrenome:</label>
                    <input type="text" id="account-last-name" placeholder="Sobrenome">

                    <label>Foto de Perfil Atual:</label>
                    <img id="current-photo-preview" src="" alt="Foto de Perfil">

                    <label for="account-image-file">Trocar Foto:</label>
                    <input type="file" id="account-image-file" accept="image/*">
                    
                    <button onclick="saveAccountDetails()">Salvar Detalhes</button>
                    <button onclick="resetProfile()" style="background-color: var(--color-red); margin-left: 10px;">Resetar Conta</button>
                </div>
            </div>

            <div id="explore-content" class="section-content">
                <h2>Explorar M√∫sicas</h2>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Pesquisar por m√∫sica ou artista..." onkeyup="searchTracks()">
                    <div id="last-search-display"></div>
                </div>
                <div id="available-tracks-container">
                </div>
            </div>
            <div id="library-content" class="section-content">
                <h2>Sua Biblioteca</h2>
                <p>Gerencie suas playlists aqui.</p>
                <div id="playlists-summary">
                </div>
            </div>
            <div id="liked-songs-content" class="section-content">
                <h2 style="color: var(--color-primary);">M√∫sicas Curtidas</h2>
                <p style="color: var(--current-subtext-color);">Suas faixas favoritas em um s√≥ lugar. Use o 'X' para descurtir.</p>
                <div id="liked-songs-tracks-container">
                </div>
            </div>
             <div id="playlist-view-content" class="section-content">
                <h2 id="current-playlist-title"></h2>
                <p style="color: var(--current-subtext-color);">Clique no t√≠tulo da faixa para tocar. Use o 'X' para remover.</p>
                <div id="playlist-tracks-container">
                </div>
            </div>
        </div>
    </div>

    <div class="player-bar">
        
        <div id="song-details-flyout">
            <div id="flyout-cover"></div>
            <div id="flyout-title"></div>
            <div id="flyout-artist"></div>
            <button id="flyout-back-btn" onclick="goBack()">Voltar</button>
        </div>

        <div class="song-info">
            <div id="player-cover" class="song-cover"></div> <div class="song-details" onclick="toggleSongDetailsFlyout()"> 
                <div id="player-title">Nenhuma M√∫sica</div>
                <div id="player-artist"></div>
            </div>
        </div>

        <div class="player-controls">
            <div class="controls">
                <button class="control-btn" id="prev-btn" onclick="prevSong()">‚èÆÔ∏è</button>
                <button class="control-btn" id="play-pause-btn" onclick="togglePlayPause()">‚ñ∂Ô∏è</button>
                <button class="control-btn" id="next-btn" onclick="nextSong()">‚è≠Ô∏è</button>
            </div>
            <div class="progress-container">
                <span id="current-time">0:00</span>
                <input type="range" id="seek-bar" min="0" max="100" value="0">
                <span id="duration">0:00</span>
            </div>
        </div>

        <div class="volume-control">
            <span id="volume-icon">üîä</span>
            <input type="range" id="volume-slider" min="0" max="100" value="100">
        </div>
        
        <audio id="audio-player"></audio>
    </div>

    <script>
        // ----------------------------------------
        // 1. DADOS E ESTADO GLOBAL 
        // ----------------------------------------

        const availableTracks = [
            { id: 1, title: "Pior Vers√£o", artist: "DJ BOY,Kako,MC Jo√£ozinho VT,MC Ryan SP,Oruam", src: "music/music1.mp3", coverUrl: "imagens/cover1.jpg" },
            { id: 2, title: "After Do Travis", artist: "DJ Russo,MC Jo√£ozinho VT,MC Marks,MC Ryan SP,MC Vine7", src: "music/music2.mp3", coverUrl: "imagens/cover2.jpg" },
            { id: 3, title: "Conex√µes de mafia", artist: "Matue", src: "music/music3.mp3", coverUrl: "imagens/cover3.jpg" },
            { id: 4, title: "Set Dj Boy 3.0", artist: "DJ BOY,Kako,Mc Don Juan,MC Hariel,MC Jo√£ozinho VT,MC Marks,MC Tuto,MC Vine7", src: "music/music4.mp3", coverUrl: "imagens/cover4.jpg" },
            { id: 5, title: "Vai Tomar No Pock Pock", artist: "MC GH Original,Mc Lele JP,MC Leozinho ZS,MC Meno K,MC Menor ZL", src: "music/music6.mp3", coverUrl: "imagens/cover6.jpg" },
            { id: 6, title: "The Box Medley 6", artist: "The Box", src: "music/music7.mp3", coverUrl: "imagens/cover7.jpg" },
            { id: 7, title: "Noite Infeliz", artist: "509-E", src: "music/music8.mp3", coverUrl: "imagens/cover8.jpg" },
            { id: 8, title: "Saque Fantasma", artist: "Mc Kelvinho", src: "music/music9.mp3", coverUrl: "imagens/cover9.jpg" },
        ];

        // Objeto de faixa de An√∫ncio atualizado com a logo corrigida
        const adTrack = { 
            id: 'ad', 
            title: "AN√öNCIO", 
            artist: "Voc√™ est√° ouvindo um an√∫ncio", 
            src: "music/anuncio.mp3", // Arquivo local solicitado
            isAd: true,
            coverUrl: "imagens/ad_cover.jpg" // Capa corrigida
        };
        
        const defaultProfilePhoto = "imagens/profile_default.png"; 
        const defaultGooglePhoto = "imagens/google_user.png"; 
        const liked_songs_playlist_id = "liked_songs_playlist";
        
        // Cores de acento dispon√≠veis para o usu√°rio
        const accentColors = {
            'Spotify Green': '#1DB954',
            'Deep Blue': '#007bff',
            'Red Hot': '#ff4500',
            'Purple Haze': '#8a2be2',
            'Cyber Yellow': '#ffff00'
        };

        let currentUser = {
            firstName: "Convidado",
            lastName: "",
            name: "Convidado",
            photo: defaultProfilePhoto, 
            isPremium: false,
            isGoogleUser: false, 
        }; 
        
        let themeSettings = {
            mode: 'dark', // 'dark' ou 'light'
            accentColor: accentColors['Spotify Green']
        };

        let allPlaylists = {}; 
        let currentPlaylistId = null; 
        let currentPlaylistTracks = [];
        let currentTrackIndex = 0;
        let isPlaying = false;
        let isAdPlaying = false; 
        let musicCounter = 0; // Conta m√∫sicas tocadas desde o √∫ltimo an√∫ncio
        let trackToAddToPlaylist = null; 
        let currentVolume = 1.0;
        let sectionHistory = []; 

        // Refer√™ncias DOM
        const audioPlayer = document.getElementById('audio-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const prevBtn = document.getElementById('prev-btn'); // Novo
        const nextBtn = document.getElementById('next-btn'); // Novo

        const playlistSelectModal = document.getElementById('playlist-select-modal');
        const searchInput = document.getElementById('search-input'); 
        const premiumToggleBtn = document.getElementById('premium-toggle-btn');
        const userStatusText = document.getElementById('user-status-text');
        const playerTitle = document.getElementById('player-title');
        const playerArtist = document.getElementById('player-artist');
        const playerCover = document.getElementById('player-cover');
        const songDetailsFlyout = document.getElementById('song-details-flyout');
        const seekBar = document.getElementById('seek-bar');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeIcon = document.getElementById('volume-icon');
        const backButton = document.getElementById('back-button');
        const profileActionsModal = document.getElementById('profile-actions-modal');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        
        // Configura√ß√µes DOM
        const settingsModal = document.getElementById('settings-modal');
        const themeModeSwitch = document.getElementById('theme-mode-switch');


        // ----------------------------------------
        // 2. FUN√á√ïES DE NAVEGA√á√ÉO E HIST√ìRICO
        // ----------------------------------------

        function updateHistory(sectionId) {
             const currentSection = sectionHistory.length > 0 ? sectionHistory[sectionHistory.length - 1] : null;
             // Adiciona a se√ß√£o ao hist√≥rico apenas se for diferente da anterior e n√£o for o flyout
             if (currentSection !== sectionId && sectionId !== 'flyout') {
                 sectionHistory.push(sectionId);
             }
             if (sectionHistory.length > 10) {
                 sectionHistory.shift();
             }
        }
        
        function showSection(sectionId, playlistId = null) { 
            const currentActiveSection = document.querySelector('.section-content.active')?.id.replace('-content', '');
            if (currentActiveSection && currentActiveSection !== sectionId && songDetailsFlyout.style.display !== 'flex') {
                updateHistory(currentActiveSection);
            }

            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            backButton.style.display = 'none'; 

            if (sectionId === 'playlist-view-content' && playlistId) {
                document.getElementById('playlist-view-content').classList.add('active'); 
                document.getElementById('current-playlist-title').textContent = allPlaylists[playlistId].name; 
                renderTracksForView(playlistId); 
                document.querySelector('.nav-item[data-section="library"]').classList.add('active');
                backButton.style.display = 'block'; 
            } else if (sectionId === 'explore') {
                document.getElementById('explore-content').classList.add('active'); 
                document.querySelector(`.nav-item[data-section="${sectionId}"]`).classList.add('active');
                searchInput.value = ''; 
                renderAvailableTracks();
            } else if (sectionId === 'liked-songs') {
                 document.getElementById('liked-songs-content').classList.add('active');
                 document.querySelector(`.nav-item[data-section="${sectionId}"]`).classList.add('active');
                 renderTracksForView(liked_songs_playlist_id, 'liked-songs-tracks-container');
            } else if (sectionId === 'account-management') {
                 document.getElementById('account-management-content').classList.add('active');
                 loadAccountDetailsForEdit();
                 backButton.style.display = 'block';
            } else {
                 document.getElementById(`${sectionId}-content`).classList.add('active'); 
                 document.querySelector(`.nav-item[data-section="${sectionId}"]`)?.classList.add('active');
            }
            
            if (songDetailsFlyout.style.display === 'flex') {
                toggleSongDetailsFlyout(true); // For√ßa fechar se estiver aberto
            }
        }

        function goBack() {
             // Se o flyout estiver aberto, feche-o e n√£o modifique o hist√≥rico (pois a abertura adicionou ao hist√≥rico)
             if (songDetailsFlyout.style.display === 'flex') {
                 toggleSongDetailsFlyout(true);
             }
             
             const previousSection = sectionHistory.pop();
             if (previousSection) {
                 showSectionNoHistory(previousSection);
             } else {
                 showSectionNoHistory('home');
             }
             
             if (sectionHistory.length === 0) {
                 backButton.style.display = 'none';
             }
        }
        
        function showSectionNoHistory(sectionId, playlistId = null) {
            // Remove a √∫ltima entrada do hist√≥rico se for a se√ß√£o atual, para evitar loop
            let tempHistory = [...sectionHistory];
            sectionHistory = []; // Zera temporariamente

            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // L√≥gica para reexibir a se√ß√£o (similar ao showSection)
            if (sectionId === 'playlist-view-content' && playlistId) {
                 document.getElementById('playlist-view-content').classList.add('active');
                 document.getElementById('current-playlist-title').textContent = allPlaylists[playlistId]?.name || 'Playlist';
                 renderTracksForView(playlistId);
                 document.querySelector('.nav-item[data-section="library"]').classList.add('active');
            } else if (sectionId === 'account-management') {
                 document.getElementById('account-management-content').classList.add('active');
                 loadAccountDetailsForEdit();
            } else if (document.getElementById(`${sectionId}-content`)) {
                 document.getElementById(`${sectionId}-content`).classList.add('active');
                 document.querySelector(`.nav-item[data-section="${sectionId}"]`)?.classList.add('active');
            }
            // N√£o precisa de else se a se√ß√£o n√£o for encontrada, o que n√£o deve acontecer se o hist√≥rico for bem mantido.

            sectionHistory = tempHistory; // Restaura o hist√≥rico
            backButton.style.display = sectionHistory.length > 0 || sectionId === 'account-management' || sectionId === 'playlist-view-content' ? 'block' : 'none';
        }


        // ----------------------------------------
        // 3. FUN√á√ïES DE RENDERIZA√á√ÉO E PLAYLISTS
        // ----------------------------------------

        function searchTracks() {
            const query = searchInput.value.toLowerCase();
            document.getElementById('last-search-display').textContent = query ? `Resultados para: "${query}"` : '';

            const filteredTracks = availableTracks.filter(track => 
                track.title.toLowerCase().includes(query) || 
                track.artist.toLowerCase().includes(query)
            );

            renderAvailableTracks(filteredTracks);
        }

        function renderAvailableTracks(tracks = availableTracks) {
            const container = document.getElementById('available-tracks-container');
            container.innerHTML = '';
            
            if (tracks.length === 0) {
                container.innerHTML = '<p style="color: var(--current-subtext-color);">Nenhuma m√∫sica encontrada com esse termo.</p>';
                return;
            }

            tracks.forEach(track => {
                const trackEl = createTrackListItem(track, 'search_temp_playlist', true);
                container.appendChild(trackEl);
            });
            
            const tempPlaylistId = 'search_temp_playlist';
            allPlaylists[tempPlaylistId] = { name: "M√∫sicas Dispon√≠veis", tracks: tracks };
        }
        
        function createTrackListItem(track, playlistId, isAvailableTrack = false, index = null) {
            const trackEl = document.createElement('div');
            trackEl.className = 'track-list-item';
            
            if (playlistId === currentPlaylistId && index === currentTrackIndex && !isAdPlaying) { 
                trackEl.classList.add('playing');
            }
            
            const trackInfo = document.createElement('div');
            trackInfo.className = 'track-info';
            const playAction = () => {
                let actualPlaylistId = playlistId;
                let actualIndex = index;

                if (isAvailableTrack) {
                    actualPlaylistId = 'search_temp_playlist';
                    const tempTracks = allPlaylists[actualPlaylistId].tracks;
                    actualIndex = tempTracks.findIndex(t => t.id === track.id && t.title === track.title);
                } 
                playSpecificTrack(actualPlaylistId, actualIndex);
            };

            trackInfo.onclick = playAction; 
            
            const trackNumber = index !== null ? `<span class="track-index">${index + 1}</span>` : '';
            trackInfo.innerHTML = `${trackNumber}<span class="track-title">${track.title}</span><span class="track-artist">${track.artist}</span>`;
            trackEl.appendChild(trackInfo);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'track-actions';

            // Bot√£o CURTIR
            const likeBtn = document.createElement('button');
            likeBtn.className = 'action-btn like';
            likeBtn.textContent = isTrackLiked(track) ? '‚ù§Ô∏è' : 'ü§ç';
            likeBtn.title = isTrackLiked(track) ? 'Descurtir' : 'Curtir';
            if (isTrackLiked(track)) { likeBtn.classList.add('liked'); }

            likeBtn.onclick = () => {
                toggleLikeTrack(track, likeBtn);
                if (playlistId === liked_songs_playlist_id && document.getElementById('liked-songs-content').classList.contains('active')) {
                     renderTracksForView(liked_songs_playlist_id, 'liked-songs-tracks-container');
                }
            }
            actionsDiv.appendChild(likeBtn);


            if (isAvailableTrack) {
                const addBtn = document.createElement('button');
                addBtn.className = 'action-btn add';
                addBtn.textContent = '‚ûï';
                addBtn.title = 'Adicionar √† Playlist';
                addBtn.onclick = () => openPlaylistSelectModal(track); 
                actionsDiv.appendChild(addBtn);
            } else if (playlistId !== liked_songs_playlist_id) { 
                const removeBtn = document.createElement('button');
                removeBtn.className = 'action-btn remove';
                removeBtn.textContent = 'X';
                removeBtn.title = 'Remover da playlist';
                removeBtn.onclick = () => removeTrackFromPlaylist(playlistId, index);
                actionsDiv.appendChild(removeBtn);
            } else {
                 const removeBtn = document.createElement('button');
                 removeBtn.className = 'action-btn remove';
                 removeBtn.textContent = 'X';
                 removeBtn.title = 'Remover das Curtidas (Descurtir)';
                 removeBtn.onclick = () => { 
                    toggleLikeTrack(track, likeBtn); 
                    if (document.getElementById('liked-songs-content').classList.contains('active')) {
                        renderTracksForView(liked_songs_playlist_id, 'liked-songs-tracks-container');
                    }
                 }; 
                 actionsDiv.appendChild(removeBtn);
            }

            trackEl.appendChild(actionsDiv);
            return trackEl;
        }

        function renderTracksForView(playlistId, containerId = 'playlist-tracks-container') {
            const container = document.getElementById(containerId); container.innerHTML = '';
            if (!allPlaylists[playlistId]) {
                 container.innerHTML = '<p style="color: var(--current-subtext-color);">Playlist n√£o encontrada.</p>';
                 return;
            }
            const tracks = allPlaylists[playlistId].tracks; 
            
            if (tracks.length === 0) { container.innerHTML = '<p style="color: var(--current-subtext-color);">Esta playlist est√° vazia.</p>'; return; }

            tracks.forEach((track, index) => {
                const trackEl = createTrackListItem(track, playlistId, false, index);
                container.appendChild(trackEl);
            });
        }
        
        function renderPlaylists() { 
            const playlistsList = document.getElementById('playlists-list'); playlistsList.innerHTML = ''; 
            const summaryDiv = document.getElementById('playlists-summary'); summaryDiv.innerHTML = '';
            const playlistKeys = Object.keys(allPlaylists).filter(id => id !== 'search_temp_playlist' && id !== liked_songs_playlist_id);

            const homeWarning = document.getElementById('home-warning');

            if (playlistKeys.length === 0) {
                summaryDiv.innerHTML = '<p style="color: var(--current-subtext-color);">Nenhuma playlist criada. Clique no "+" acima.</p>';
                homeWarning.textContent = 'Crie uma playlist na Biblioteca para come√ßar a tocar!';
            } else { homeWarning.textContent = ''; }

            playlistKeys.forEach(id => {
                const playlist = allPlaylists[id];
                const sidebarItem = document.createElement('div'); sidebarItem.className = 'playlist-item';
                const nameLink = document.createElement('span'); nameLink.className = 'playlist-name-link'; nameLink.textContent = playlist.name; nameLink.onclick = () => showSection('playlist-view-content', id); sidebarItem.appendChild(nameLink);
                const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-btn'; deleteBtn.textContent = 'X'; deleteBtn.title = 'Excluir playlist'; deleteBtn.onclick = (e) => deletePlaylist(e, id); sidebarItem.appendChild(deleteBtn);
                playlistsList.appendChild(sidebarItem);
                summaryDiv.innerHTML += `<div class="playlist-item"><span class="playlist-name-link" onclick="showSection('playlist-view-content', '${id}')">${playlist.name} (${playlist.tracks.length} m√∫sicas)</span><button class="delete-btn" title="Excluir playlist" onclick="deletePlaylist(event, '${id}')">X</button></div>`;
            });
            
            const firstPlaylistId = playlistKeys[0];
            if (firstPlaylistId) {
                 document.getElementById('playlist-view-home').innerHTML = `<h3>${allPlaylists[firstPlaylistId].name}</h3>`;
                 renderTracksForView(firstPlaylistId, 'playlist-view-home'); 
            } else { document.getElementById('playlist-view-home').innerHTML = ''; }
            
            renderTracksForView(liked_songs_playlist_id, 'liked-songs-tracks-container');
        }

        function loadPlaylists() { 
            const storedPlaylists = localStorage.getItem('spotifyPlaylists');
            if (storedPlaylists) { allPlaylists = JSON.parse(storedPlaylists); } 
            
            if (!allPlaylists[liked_songs_playlist_id]) {
                allPlaylists[liked_songs_playlist_id] = { name: "M√∫sicas Curtidas", tracks: [] };
            }

            // Garante que a lista de dispon√≠veis esteja sempre carregada
            allPlaylists['search_temp_playlist'] = { name: "M√∫sicas Dispon√≠veis", tracks: availableTracks };

            const userPlaylists = Object.keys(allPlaylists).filter(id => id !== 'search_temp_playlist' && id !== liked_songs_playlist_id);
            
            currentPlaylistId = currentPlaylistId || userPlaylists[0] || liked_songs_playlist_id; 
            updateCurrentPlaylistTracks(); 
            savePlaylists();
        }
        
        function savePlaylists() { 
            const playlistsToSave = {};
            Object.keys(allPlaylists).filter(id => id !== 'search_temp_playlist').forEach(id => {
                playlistsToSave[id] = allPlaylists[id];
            });
            localStorage.setItem('spotifyPlaylists', JSON.stringify(playlistsToSave)); 
        }
        
        function updateCurrentPlaylistTracks() { 
            if (currentPlaylistId && allPlaylists[currentPlaylistId]) { currentPlaylistTracks = allPlaylists[currentPlaylistId].tracks; } else { currentPlaylistTracks = []; currentPlaylistId = null; }
        }
        
        function createNewPlaylist(autoAddTrack = false) {
            const name = prompt("Digite o nome da nova playlist:");
            if (name && name.trim()) {
                const newId = 'playlist_' + Date.now();
                allPlaylists[newId] = { name: name.trim(), tracks: [] };
                savePlaylists();
                renderPlaylists();
                alert(`Playlist "${name.trim()}" criada!`);
                
                if (autoAddTrack && trackToAddToPlaylist) {
                    addTrackToPlaylist(newId, trackToAddToPlaylist);
                }
            }
        }
        
        function deletePlaylist(e, id) {
             e.stopPropagation(); 
             if (confirm(`Tem certeza que deseja excluir a playlist "${allPlaylists[id].name}"?`)) {
                 delete allPlaylists[id];
                 savePlaylists();
                 renderPlaylists();
                 if (currentPlaylistId === id) {
                     currentPlaylistId = null;
                     updateCurrentPlaylistTracks();
                     loadCurrentTrack();
                     showSection('home');
                 }
             }
        }

        function removeTrackFromPlaylist(playlistId, index) {
            if (confirm(`Remover "${allPlaylists[playlistId].tracks[index].title}" desta playlist?`)) {
                allPlaylists[playlistId].tracks.splice(index, 1);
                savePlaylists();
                renderTracksForView(playlistId);
                renderPlaylists(); // Atualiza a contagem na sidebar
                if (currentPlaylistId === playlistId) {
                    updateCurrentPlaylistTracks();
                    if (currentTrackIndex === index) {
                        loadCurrentTrack(); 
                        audioPlayer.pause();
                        isPlaying = false;
                        playPauseBtn.textContent = '‚ñ∂Ô∏è';
                    } else if (currentTrackIndex > index) {
                        currentTrackIndex--;
                    }
                }
            }
        }
        
        function addTrackToPlaylist(playlistId, track) { 
            const trackClone = availableTracks.find(t => t.id === track.id && t.title === track.title);
            if (!trackClone) return;

            const exists = allPlaylists[playlistId].tracks.some(t => t.id === trackClone.id && t.title === trackClone.title && t.artist === trackClone.artist);
            
            if (!exists) { 
                allPlaylists[playlistId].tracks.push({...trackClone}); 
                savePlaylists(); 
                alert(`"${trackClone.title}" adicionada √† playlist "${allPlaylists[playlistId].name}".`); 
            } else { 
                alert(`"${trackClone.title}" j√° est√° na playlist "${allPlaylists[playlistId].name}".`); 
            }
            closePlaylistSelectModal();
            renderPlaylists();
        }
        
        function isTrackLiked(track) {
            const likedTracks = allPlaylists[liked_songs_playlist_id]?.tracks || [];
            return likedTracks.some(t => t.id === track.id && t.title === track.title);
        }

        function toggleLikeTrack(track, buttonElement = null) {
            const likedTracksPlaylist = allPlaylists[liked_songs_playlist_id];
            
            const trackClone = availableTracks.find(t => t.id === track.id && t.title === track.title) || track;
            if (!trackClone) return;

            if (isTrackLiked(trackClone)) {
                const index = likedTracksPlaylist.tracks.findIndex(t => t.id === trackClone.id && t.title === trackClone.title);
                if (index > -1) {
                    if (currentPlaylistId === liked_songs_playlist_id && currentTrackIndex === index) { audioPlayer.pause(); isPlaying = false; }
                    likedTracksPlaylist.tracks.splice(index, 1);
                    alert(`"${trackClone.title}" removida das M√∫sicas Curtidas.`);
                    if (currentPlaylistId === liked_songs_playlist_id && currentTrackIndex >= likedTracksPlaylist.tracks.length) { 
                         currentTrackIndex = 0; loadCurrentTrack();
                    }
                }
                if (buttonElement) { buttonElement.textContent = 'ü§ç'; buttonElement.title = 'Curtir'; buttonElement.classList.remove('liked'); }
            } else {
                likedTracksPlaylist.tracks.unshift({...trackClone}); 
                alert(`"${trackClone.title}" adicionada √†s M√∫sicas Curtidas.`);
                if (buttonElement) { buttonElement.textContent = '‚ù§Ô∏è'; buttonElement.title = 'Descurtir'; buttonElement.classList.add('liked'); }
            }
            savePlaylists();
            renderPlaylists();
        }


        // ----------------------------------------
        // 4. FUN√á√ïES DO PLAYER E AN√öNCIOS 
        // ----------------------------------------
        
        function updatePlayerControls(isAd) {
             // Desativa o seek bar e os bot√µes de pular se for an√∫ncio
             seekBar.disabled = isAd;
             prevBtn.disabled = isAd;
             nextBtn.disabled = isAd;
        }

        function updatePlayingIndicator() {
             // Redesenha as faixas da playlist atual para atualizar a classe 'playing'
             if (currentPlaylistId === 'search_temp_playlist') {
                renderAvailableTracks(allPlaylists['search_temp_playlist'].tracks);
             } else if (currentPlaylistId === liked_songs_playlist_id) {
                renderTracksForView(liked_songs_playlist_id, 'liked-songs-tracks-container');
             } else if (currentPlaylistId && document.getElementById('playlist-view-content').classList.contains('active')) {
                renderTracksForView(currentPlaylistId);
             }
        }

        function checkAndPlayAd(nextTrackAction) { 
            // 1. Caso Premium: Pula an√∫ncios
            if (currentUser.isPremium) { 
                musicCounter = 0; 
                isAdPlaying = false; 
                updatePlayerControls(false); 
                audioPlayer.onended = nextSong; // Garante o comportamento padr√£o
                nextTrackAction(); 
                return;
            }
            
            // 2. Caso de Retorno Ap√≥s An√∫ncio
            // Se a m√∫sica anterior foi um an√∫ncio, reseta o estado e toca a pr√≥xima m√∫sica real
            if (isAdPlaying) {
                musicCounter = 0; 
                isAdPlaying = false; 
                updatePlayerControls(false); // Controles ativos para a m√∫sica real
                audioPlayer.onended = nextSong; // Restaura o listener padr√£o
                nextTrackAction();
                return;
            }
            
            // 3. Caso de Tocar An√∫ncio (a cada 2 m√∫sicas)
            if (musicCounter >= 2) { 
                isAdPlaying = true; 
                updatePlayerControls(true); // Controles desativados para o an√∫ncio
                
                // Configura o `onended` para tocar a pr√≥xima M√öSICA REAL automaticamente!
                // Ao terminar o AD, ele chama nextSong(), que cair√° no "Caso de Retorno Ap√≥s An√∫ncio"
                audioPlayer.onended = nextSong; 
                
                loadAndPlayCurrentTrack(); 
                playPauseBtn.textContent = '‚è∏Ô∏è';
                
            } else { 
                // 4. Caso de Tocar M√∫sica Normal
                musicCounter++; 
                updatePlayerControls(false); // Controles ativos para m√∫sica real
                audioPlayer.onended = nextSong; // Garante o comportamento padr√£o
                nextTrackAction(); 
            }
        }
        
        function loadCurrentTrack() { 
            if (!currentPlaylistId || (currentPlaylistTracks.length === 0 && !isAdPlaying)) { 
                audioPlayer.src = ''; 
                playerTitle.textContent = "Nenhuma M√∫sica"; 
                playerArtist.textContent = ""; 
                playerArtist.classList.remove('ad-message');

                playerCover.textContent = 'üíø';
                playerCover.style.backgroundImage = 'none';
                playerCover.classList.remove('ad-cover');

                document.getElementById('flyout-title').textContent = "Nenhuma M√∫sica Selecionada";
                document.getElementById('flyout-artist').textContent = "Inicie a reprodu√ß√£o de uma playlist.";
                document.getElementById('flyout-cover').textContent = 'üíø';
                document.getElementById('flyout-cover').style.backgroundImage = 'none';

                currentTimeEl.textContent = "0:00"; durationEl.textContent = "0:00"; seekBar.value = 0;
                
                updatePlayerControls(false); // Garante que controles n√£o fiquem desativados se o player estiver vazio
                
                return; 
            }
            
            const track = isAdPlaying ? adTrack : currentPlaylistTracks[currentTrackIndex];
            
            audioPlayer.src = track.src; 
            playerTitle.textContent = track.title; 
            
            // L√≥gica do Artista e Capa (An√∫ncio vs M√∫sica Normal)
            if (isAdPlaying) {
                 playerArtist.textContent = track.artist; // "Voc√™ est√° ouvindo um an√∫ncio"
                 playerArtist.classList.add('ad-message');

                 playerCover.textContent = ''; // Limpa o √≠cone
                 playerCover.style.backgroundImage = `url('${track.coverUrl}')`; // Usa ad_cover.jpg
                 playerCover.classList.add('ad-cover'); // Mant√©m o estilo para garantir tamanho/posi√ß√£o
                 
                 document.getElementById('flyout-title').textContent = track.title;
                 document.getElementById('flyout-artist').textContent = track.artist;
                 document.getElementById('flyout-cover').textContent = '';
                 document.getElementById('flyout-cover').style.backgroundImage = `url('${track.coverUrl}')`;
                 
                 updatePlayerControls(true); // Desativa controles
            } else {
                 playerArtist.textContent = track.artist; 
                 playerArtist.classList.remove('ad-message');

                 playerCover.textContent = ''; 
                 playerCover.style.backgroundImage = `url('${track.coverUrl}')`;
                 playerCover.classList.remove('ad-cover');

                 document.getElementById('flyout-title').textContent = track.title;
                 document.getElementById('flyout-artist').textContent = track.artist;
                 document.getElementById('flyout-cover').textContent = '';
                 document.getElementById('flyout-cover').style.backgroundImage = `url('${track.coverUrl}')`;

                 updatePlayerControls(false); // Ativa controles
            }
            
            playerCover.style.backgroundSize = 'cover';
            playerCover.style.backgroundPosition = 'center';
            document.getElementById('flyout-cover').style.backgroundSize = 'cover';
            document.getElementById('flyout-cover').style.backgroundPosition = 'center';
            
            audioPlayer.load(); // Carrega a nova fonte
        }
        
        function loadAndPlayCurrentTrack() { 
            loadCurrentTrack();
            if (currentPlaylistTracks.length > 0 || isAdPlaying) { 
                // Tenta tocar. O play() pode falhar se n√£o houver intera√ß√£o pr√©via do usu√°rio.
                audioPlayer.play().catch(error => {
                    console.error("Erro ao tentar reproduzir √°udio automaticamente:", error);
                    // Mostra um aviso ao usu√°rio se for a primeira tentativa de play
                    if (!isPlaying) {
                        alert("O navegador bloqueou a reprodu√ß√£o autom√°tica. Clique no bot√£o ‚ñ∂Ô∏è para come√ßar.");
                    }
                }); 
                playPauseBtn.textContent = '‚è∏Ô∏è'; 
                isPlaying = true; 
            }
        }
        
        function playSpecificTrack(playlistId, trackIndex) { 
            if (!allPlaylists[playlistId] || allPlaylists[playlistId].tracks.length === 0) return;
            musicCounter = 0; 
            isAdPlaying = false; 
            currentPlaylistId = playlistId; 
            updateCurrentPlaylistTracks(); 
            currentTrackIndex = trackIndex;
            loadAndPlayCurrentTrack(); 
            updatePlayingIndicator();
        }
        
        function togglePlayPause() { 
             if (!currentPlaylistId || (currentPlaylistTracks.length === 0 && !isAdPlaying)) return;
            if (audioPlayer.paused) { 
                audioPlayer.play(); 
                playPauseBtn.textContent = '‚è∏Ô∏è'; 
                isPlaying = true; 
            } else { 
                audioPlayer.pause(); 
                playPauseBtn.textContent = '‚ñ∂Ô∏è'; 
                isPlaying = false; 
            }
        }

        function nextSong() { 
            
            // 1. Se for an√∫ncio e o usu√°rio tentou pular: Bloqueia
            if (isAdPlaying && !audioPlayer.paused && !audioPlayer.ended) { 
                // S√≥ bloqueia se n√£o foi o evento 'ended' que chamou (i.e., clique do usu√°rio)
                return;
            }
            
            // 2. Se a playlist estiver vazia (e n√£o for an√∫ncio), para
            if (currentPlaylistTracks.length === 0 && !isAdPlaying) return;
            
            // Fun√ß√£o interna para avan√ßar para a pr√≥xima faixa real na playlist
            const advanceToNextTrack = () => { 
                currentTrackIndex = (currentTrackIndex + 1) % currentPlaylistTracks.length; 
                loadAndPlayCurrentTrack(); 
                updatePlayingIndicator(); 
            };
            
            // Se o an√∫ncio terminou (isAdPlaying *ainda* √© true do estado anterior), avan√ßa para a pr√≥xima m√∫sica real
            if (isAdPlaying) {
                 // A flag isAdPlaying √© resetada dentro de checkAndPlayAd
                 checkAndPlayAd(advanceToNextTrack); 
            } else {
                 // Se √© uma m√∫sica normal, verifica se precisa tocar um an√∫ncio antes de avan√ßar
                 checkAndPlayAd(advanceToNextTrack);
            }
        }
        
        function prevSong() { 
            // Bloqueia se for an√∫ncio
            if (isAdPlaying) return;

            if (currentPlaylistTracks.length === 0 && !isAdPlaying) return; 
            musicCounter = 0; isAdPlaying = false; 
            updatePlayerControls(false); // Controles ativos
            currentTrackIndex = (currentTrackIndex - 1 + currentPlaylistTracks.length) % currentPlaylistTracks.length;
            loadAndPlayCurrentTrack(); 
            updatePlayingIndicator();
        }

        function toggleSongDetailsFlyout(forceClose = false) {
            if (currentPlaylistTracks.length === 0 && !isAdPlaying) return; 

            if (songDetailsFlyout.style.display === 'flex' || forceClose) {
                songDetailsFlyout.style.display = 'none';
            } else {
                updateHistory('flyout'); // Usa 'flyout' como um marcador no hist√≥rico
                loadCurrentTrack(); 
                songDetailsFlyout.style.display = 'flex';
            }
        }

        // --- Fun√ß√µes de Player/UI (Volume, Tempo, etc.) ---
        seekBar.addEventListener('input', () => {
            if (seekBar.disabled) return; // Se desativado, n√£o faz nada
            const seekTime = audioPlayer.duration * (seekBar.value / 100);
            audioPlayer.currentTime = seekTime;
        });

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "0:00";
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            const paddedSeconds = remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds;
            return `${minutes}:${paddedSeconds}`;
        }

        function updateProgress() {
            const duration = audioPlayer.duration;
            const currentTime = audioPlayer.currentTime;

            currentTimeEl.textContent = formatTime(currentTime);
            durationEl.textContent = formatTime(duration);

            if (isFinite(duration)) {
                const percentage = (currentTime / duration) * 100;
                seekBar.value = percentage;
                
                // Pega a cor prim√°ria atual (garantida de ser a mesma do :root)
                const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary');

                if (isAdPlaying) {
                    // Barra de progresso do an√∫ncio (cor neutra)
                     seekBar.style.background = `linear-gradient(to right, #707070 0%, #707070 ${percentage}%, #404040 ${percentage}%, #404040 100%)`;
                } else {
                    // Barra de progresso normal (cor prim√°ria din√¢mica)
                    seekBar.style.background = `linear-gradient(to right, ${accentColor} 0%, ${accentColor} ${percentage}%, #404040 ${percentage}%, #404040 100%)`;
                }

            } else {
                seekBar.value = 0;
                seekBar.style.background = '#404040';
            }
        }
        
        function updateVolumeIcon() {
            if (currentVolume == 0) {
                 volumeIcon.textContent = 'üîá';
            } else if (currentVolume < 0.5) {
                 volumeIcon.textContent = 'üîà';
            } else {
                 volumeIcon.textContent = 'üîä';
            }
        }

        volumeSlider.addEventListener('input', () => {
            currentVolume = volumeSlider.value / 100;
            audioPlayer.volume = currentVolume;
            localStorage.setItem('spotifyVolume', currentVolume);
            updateVolumeIcon();
        });

        // ----------------------------------------
        // 5. FUN√á√ïES DE PERFIL E LOGIN
        // ----------------------------------------
        
        function loadProfile() { 
            const storedProfile = localStorage.getItem('spotifyUserProfile');
            const storedVolume = localStorage.getItem('spotifyVolume');

            if (storedProfile) {
                const loadedProfile = JSON.parse(storedProfile);
                currentUser = { 
                    ...currentUser, 
                    firstName: loadedProfile.firstName || 'Convidado',
                    lastName: loadedProfile.lastName || '',
                    name: (loadedProfile.firstName + ' ' + loadedProfile.lastName).trim() || 'Convidado',
                    photo: loadedProfile.photo || defaultProfilePhoto, 
                    isPremium: loadedProfile.isPremium || false,
                    isGoogleUser: loadedProfile.isGoogleUser || false
                };
            }

            if (currentUser.name === 'Convidado' && currentUser.isGoogleUser) {
                 currentUser.name = 'Usu√°rio do Google';
            } else if (currentUser.name === '') {
                 currentUser.name = currentUser.firstName;
            }

            if (storedVolume !== null) {
                currentVolume = parseFloat(storedVolume);
                audioPlayer.volume = currentVolume;
                volumeSlider.value = currentVolume * 100;
            } else {
                audioPlayer.volume = currentVolume;
            }
            updateVolumeIcon();
            updateProfileUI();
        }
        
        function saveProfile() { 
            // Fun√ß√£o interna para persistir o estado do currentUser
            localStorage.setItem('spotifyUserProfile', JSON.stringify({
                firstName: currentUser.firstName,
                lastName: currentUser.lastName,
                photo: currentUser.photo,
                isPremium: currentUser.isPremium,
                isGoogleUser: currentUser.isGoogleUser
            }));
            updateProfileUI();
        }

        function updatePremiumUI() {
            if (currentUser.isPremium) {
                premiumToggleBtn.textContent = 'Conta Premium';
                premiumToggleBtn.classList.add('active');
                userStatusText.textContent = 'Premium (sem an√∫ncios)';
                userStatusText.style.color = 'var(--color-primary)';
            } else {
                premiumToggleBtn.textContent = 'Obter Premium';
                premiumToggleBtn.classList.remove('active');
                userStatusText.textContent = 'Gratuito (com an√∫ncios)';
                userStatusText.style.color = 'var(--color-yellow)';
            }
        }

        function updateProfileUI() { 
            currentUser.name = (currentUser.firstName + ' ' + currentUser.lastName).trim() || 'Convidado';
            if (currentUser.name === 'Convidado' && currentUser.isGoogleUser) {
                 currentUser.name = 'Usu√°rio do Google';
            } else if (currentUser.name === '') {
                 currentUser.name = currentUser.firstName;
            }

            document.getElementById('profile-image').src = currentUser.photo; 
            document.getElementById('profile-name').textContent = currentUser.name; 
            document.getElementById('welcome-name').textContent = currentUser.name; 
            updatePremiumUI();
        }

        function openProfileActionsModal() {
            document.getElementById('modal-user-name').textContent = currentUser.name;
            if (currentUser.isGoogleUser) {
                document.getElementById('logged-in-actions').style.display = 'block';
                document.getElementById('logged-out-actions').style.display = 'none';
            } else {
                 document.getElementById('logged-in-actions').style.display = 'none';
                 document.getElementById('logged-out-actions').style.display = 'block';
            }
            profileActionsModal.style.display = 'block';
        }

        function closeProfileActionsModal() {
            profileActionsModal.style.display = 'none';
        }
        
        function simulateGoogleLogin() {
             currentUser.isGoogleUser = true;
             currentUser.firstName = "Usu√°rio";
             currentUser.lastName = "Google";
             currentUser.photo = defaultGooglePhoto;
             saveProfile();
             closeProfileActionsModal();
             alert("Conex√£o simulada com o Google bem-sucedida! Gerencie sua conta agora.");
        }

        function logout() {
            currentUser.isGoogleUser = false;
            currentUser.firstName = "Convidado";
            currentUser.lastName = "";
            currentUser.photo = defaultProfilePhoto;
            saveProfile();
            closeProfileActionsModal();
            alert("Voc√™ saiu da sua conta.");
            showSection('home');
        }

        function manageAccount() {
            closeProfileActionsModal();
            showSection('account-management');
        }

        function loadAccountDetailsForEdit() {
            document.getElementById('account-first-name').value = currentUser.firstName === 'Convidado' || currentUser.firstName === 'Usu√°rio do Google' ? '' : currentUser.firstName;
            document.getElementById('account-last-name').value = currentUser.lastName;
            document.getElementById('current-photo-preview').src = currentUser.photo;
            document.getElementById('account-image-file').value = null; // Limpa o input de arquivo
        }

        function saveAccountDetails() {
            const firstName = document.getElementById('account-first-name').value.trim();
            const lastName = document.getElementById('account-last-name').value.trim();
            const fileInput = document.getElementById('account-image-file');

            if (firstName) {
                currentUser.firstName = firstName;
            } else {
                currentUser.firstName = currentUser.isGoogleUser ? 'Usu√°rio do Google' : 'Convidado';
            }
            currentUser.lastName = lastName;
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentUser.photo = event.target.result; 
                    saveProfile(); 
                    alert("Detalhes da conta e foto salvos!");
                };
                reader.readAsDataURL(file);
            } else {
                saveProfile(); 
                alert("Detalhes da conta salvos!");
            }
            
            goBack();
        }

        function resetProfile() { 
            if (confirm("Isto ir√° redefinir seu perfil (para Convidado), volume e todas as suas playlists. Continuar?")) {
                currentUser = { 
                    firstName: "Convidado", 
                    lastName: "", 
                    name: "Convidado",
                    photo: defaultProfilePhoto, 
                    isPremium: false,
                    isGoogleUser: false 
                };
                currentVolume = 1.0;
                localStorage.removeItem('spotifyVolume');
                saveProfile(); 
                allPlaylists = {}; 
                savePlaylists(); 
                loadPlaylists(); 
                loadCurrentTrack(); 
                showSection('home');
            }
        }

        function openPremiumModal() { 
            if (!currentUser.isPremium) { document.getElementById('premium-modal').style.display = 'block'; } 
        }
        function closePremiumModal() { document.getElementById('premium-modal').style.display = 'none'; }
        
        function simulatePurchase() { 
            const cardNumber = document.getElementById('card-number').value;
            if (cardNumber.length < 16) { alert("Por favor, preencha um n√∫mero de cart√£o v√°lido para a simula√ß√£o."); return; }
            currentUser.isPremium = true; saveProfile(); closePremiumModal(); alert(`üéâ Parab√©ns, ${currentUser.name}! Sua conta Premium foi ativada. Aproveite as m√∫sicas sem an√∫ncios!`);
            
            // Se um an√∫ncio estiver tocando, interrompe e avan√ßa para a pr√≥xima m√∫sica real
            if (isAdPlaying) { 
                audioPlayer.pause(); 
                isAdPlaying = false; 
                musicCounter = 0; 
                updatePlayerControls(false); // Reativa controles
                nextSong(); 
            }
        }
        
        function openPlaylistSelectModal(track) { 
            trackToAddToPlaylist = track;
            const optionsContainer = document.getElementById('playlist-options-container'); optionsContainer.innerHTML = '';
            const playlistKeys = Object.keys(allPlaylists).filter(id => id !== 'search_temp_playlist' && id !== liked_songs_playlist_id);
            if (playlistKeys.length === 0) { optionsContainer.innerHTML = '<p style="color: var(--current-subtext-color); font-size: 0.9em;">Nenhuma playlist encontrada.</p>'; } 
            else {
                 playlistKeys.forEach(id => {
                    const name = allPlaylists[id].name;
                    const btn = document.createElement('button'); btn.style.display = 'block'; btn.style.width = '100%'; btn.style.textAlign = 'left'; btn.style.marginTop = '5px';
                    btn.textContent = name; btn.onclick = () => addTrackToPlaylist(id, track); optionsContainer.appendChild(btn);
                 });
            }
            document.getElementById('playlist-select-modal').style.display = 'block';
        }
        function closePlaylistSelectModal() { trackToAddToPlaylist = null; document.getElementById('playlist-select-modal').style.display = 'none'; }

        // ----------------------------------------
        // 6. FUN√á√ïES DE TEMA E ESTILIZA√á√ÉO
        // ----------------------------------------
        
        function loadTheme() {
            const storedTheme = localStorage.getItem('spotifyThemeSettings');
            if (storedTheme) {
                themeSettings = JSON.parse(storedTheme);
            }
            applyTheme();
        }

        function applyTheme(tempAccentColor = null) {
            const root = document.documentElement;
            const body = document.body;
            const finalColor = tempAccentColor || themeSettings.accentColor;
            
            // 1. Aplica a Cor de Acento (Primary Color)
            root.style.setProperty('--color-primary', finalColor);
            
            // 2. Aplica o Modo Claro/Escuro
            if (themeSettings.mode === 'light') {
                body.classList.add('light-mode');
                themeModeSwitch.textContent = 'Modo: CLARO (Clique para ESCURO)';
                themeModeSwitch.classList.remove('switch-dark');
                themeModeSwitch.classList.add('switch-light');
            } else {
                body.classList.remove('light-mode');
                themeModeSwitch.textContent = 'Modo: ESCURO (Clique para CLARO)';
                themeModeSwitch.classList.remove('switch-light');
                themeModeSwitch.classList.add('switch-dark');
            }
            
            // Atualiza a barra de progresso (se estiver tocando)
            updateProgress();
            
            // Re-renderiza a lista de m√∫sicas para aplicar a cor do √≠cone de 'playing'
            updatePlayingIndicator();
            
            // Renderiza as op√ß√µes de cor no modal (se estiver aberto)
            renderColorOptions(finalColor);
        }
        
        function openSettingsModal() {
            // Garante que o estado do switch e das cores esteja atualizado ao abrir
            applyTheme(); 
            settingsModal.style.display = 'block';
        }

        function toggleThemeMode() {
            const newMode = themeSettings.mode === 'dark' ? 'light' : 'dark';
            themeSettings.mode = newMode;
            applyTheme(); // Aplica imediatamente para pr√©-visualiza√ß√£o
        }

        function renderColorOptions(currentAccent) {
            const container = document.getElementById('color-options-container');
            container.innerHTML = '';
            
            Object.keys(accentColors).forEach(name => {
                const color = accentColors[name];
                const option = document.createElement('span');
                option.className = 'color-option';
                option.title = name;
                option.style.backgroundColor = color;
                option.dataset.color = color;

                if (color.toLowerCase() === currentAccent.toLowerCase()) {
                    option.classList.add('selected');
                }

                option.onclick = function() {
                    document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                    this.classList.add('selected');
                    // Aplica a cor temporariamente para pr√©-visualiza√ß√£o, mantendo o modo
                    applyTheme(color); 
                    themeSettings.accentColor = color; // Atualiza o estado tempor√°rio
                };
                container.appendChild(option);
            });
        }
        
        function saveThemeSettings() {
            // A cor j√° foi atualizada em themeSettings.accentColor
            // O modo j√° foi atualizado em themeSettings.mode
            localStorage.setItem('spotifyThemeSettings', JSON.stringify(themeSettings));
            // applyTheme j√° foi chamada em toggleThemeMode ou na sele√ß√£o de cor, 
            // mas chamamos novamente para garantir a atualiza√ß√£o final.
            applyTheme(); 
            settingsModal.style.display = 'none';
            alert('Configura√ß√µes de Tema salvas! Reinicie o player se notar inconsist√™ncias visuais.');
        }

        // ----------------------------------------
        // 7. INICIALIZA√á√ÉO
        // ----------------------------------------

        window.onload = () => {
            if (songDetailsFlyout.style.display !== 'none') {
                songDetailsFlyout.style.display = 'none';
            }
            
            loadTheme(); // Carrega e aplica o tema ANTES de carregar o perfil/playlists
            loadProfile();
            loadPlaylists();
            renderPlaylists(); 
            
            // Tenta carregar a primeira m√∫sica/estado inicial para ter o player pronto
            loadCurrentTrack(); 
            
            sectionHistory = [];
            showSection('home'); 
            
            // Configura o `onended` inicial para chamar nextSong. A fun√ß√£o checkAndPlayAd lida com o an√∫ncio.
            audioPlayer.addEventListener('ended', nextSong); 
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', updateProgress);
        };
    </script>
</body>
</html>